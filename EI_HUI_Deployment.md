# Ellison Institute Deployment of HistomicsUI

This document includes instructions on how to set up and access EI's HistomicsUI.  

Updated 05/11/2020


<details> 
<summary> <b>  User Instructions </b> </summary>

### Login
TODO: Include instructions here once final deployment is finished.

### Import 

General users can upload images through their account in the UI.  In-place import of data on the OCI file system can only be done by admins through the admin console in the UI. 

### Format Requirements

To be viewed by default, images must be in the tiled tiff format.  The UI can also convert images to this format by clicking the button that looks like a landscape photo on the image detail page, but this will create a copy of the image in the database.

### HistomicsUI vs. Image Detail Page

When you first click on an image from the UI file browser, it will take you to a detail page that may or may not show an image preview (depending on file format) and some other information and metadata.  To view the full HistomicsUI page with full zoom and annotation capability, click the drop down menu in the top right and select "View in HistomicsUI".

</details>

<details> 
<summary> <b>  Admin/Developer Instructions </b> </summary>

### Setup

The HistomicsUI web server must be run on a compute instance with the /Datashare FSS mounted. 

To start the server, run `CURRENT_UID=$(id -u):$(id -g) docker-compose up` from the folder containing docker-compose.yml (`digital_slide_archive/devlops/dsa`).

If there are no existing users (i.e. the first time this is deployed, a default user will be created with username `admin` and password `password`.  Make sure to delete this user once the real admin user is created.

### Implementation Details

All of the information relating to HistomicsUI is stored in `/Datashare/HistomicsUI/`.

### Access Control

HistomicsUI includes several access control features out of the box:
* Users 
	* Have their own public and private data repositories
	* Users can be:
		* Admin - can manage other users, access control, and perform in-place import
		* Regular - can manage their own data and upload images through the UI
* Groups 
	* Can be public or private 
	* Users within a group can be:
		* Admin
		* Moderator
		* Member 
* Collections
	* Groupings of data or analyses 
	* Can be public or private
	* Access can be given to other users/groups on the following bases:
		* Can view
		* Can edit
		* Owner

#### Assetstore 

`/Datashare/HistomicsUI/assetstore/` is where all assets (i.e. images) uploaded or created through the UI will be stored.  

To create another FileSystem assetstore, the directory must be mounted to the docker container by adding an entry in the `volumes` section of docker-compose.yml. Then the new assetstore can be created through the UI, or by adding a line to the assetstores section of girder_config.py.

#### Database

HistomcsUI uses MongoDB to store users, annotations, metadata, etc.  All the MongoDB files are stored in `/Datashare/HistomcsUI/db/`.

To connect to the MongoDB instance using the mongo shell, find the port the dsa_mongodb docker container is running on using `docker ps`, then run `mongo --host localhost:<port>` from the server.

From the mongo shell, all the relevant information is in a db called `girder`.
The `girder` db has the following collections:
* annotation - stores metadata about the annotation
* annotationelement - stores the location/shape of the annotation itself
* api_key
* assetstore 
* collection
* file
* folder
* group
* item - generic, images and their metadata can be found here
* job
* notification
* setting
* token
* upload
* user

#### Logs

Any logs generated by HistomicsUI are put in `/Datashare/HistomicsUI/logs/`.

</details>
